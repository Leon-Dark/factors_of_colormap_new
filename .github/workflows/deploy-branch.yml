name: Deploy Branch to Subdirectory

on:
  push:
    branches:
      - main
      - random
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          path: source
      
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true
      
      - name: Determine deployment path
        id: path
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "deploy_path=." >> $GITHUB_OUTPUT
            echo "üìå Deploying to root directory"
          elif [ "$BRANCH_NAME" = "random" ]; then
            echo "deploy_path=random" >> $GITHUB_OUTPUT
            echo "üìå Deploying to /random"
          else
            echo "‚ùå Unknown branch: $BRANCH_NAME"
            exit 1
          fi
      
      - name: Prepare gh-pages directory
        run: |
          # Â¶ÇÊûú gh-pages ÂàÜÊîØ‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂàùÂßãÁªìÊûÑ
          if [ ! -d "gh-pages" ]; then
            mkdir -p gh-pages
            echo "Creating new gh-pages branch"
          fi
          
          # ÂàõÂª∫ÊàñÊ∏ÖÁêÜÁõÆÊ†áÁõÆÂΩï
          TARGET_PATH="gh-pages/${{ steps.path.outputs.deploy_path }}"
          rm -rf "$TARGET_PATH"
          mkdir -p "$TARGET_PATH"
          
          # Â§çÂà∂Ê∫êÊñá‰ª∂
          if [ "${{ steps.path.outputs.deploy_path }}" = "." ]; then
            # main ÂàÜÊîØÔºöÂ§çÂà∂Âà∞Ê†πÁõÆÂΩïÔºà‰øùÁïôÂÖ∂‰ªñÂàÜÊîØÁöÑÂ≠êÁõÆÂΩïÔºâ
            cp -r source/Colormap_Visualizer gh-pages/
            cp -r source/gaussian_perturbation_system gh-pages/
            cp -r source/"rainbows good or bad for" gh-pages/
            
            # ÂàõÂª∫‰∏ªÁ¥¢ÂºïÈ°µ
            cat > gh-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Factors of Colormap - Main</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 40px 20px;
              }
              .container {
                max-width: 900px;
                margin: 0 auto;
              }
              h1 {
                color: white;
                text-align: center;
                margin-bottom: 40px;
                font-size: 2.5em;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
              }
              .section {
                background: white;
                border-radius: 12px;
                padding: 30px;
                margin-bottom: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                transition: transform 0.3s ease;
              }
              .section:hover {
                transform: translateY(-5px);
              }
              .section h2 {
                color: #667eea;
                margin-bottom: 15px;
                font-size: 1.5em;
                border-bottom: 2px solid #f0f0f0;
                padding-bottom: 10px;
              }
              ul {
                list-style: none;
                padding: 0;
              }
              li {
                margin: 12px 0;
              }
              a {
                color: #667eea;
                text-decoration: none;
                font-size: 1.1em;
                display: inline-flex;
                align-items: center;
                transition: all 0.3s ease;
              }
              a:before {
                content: "‚Üí";
                margin-right: 8px;
                transition: transform 0.3s ease;
              }
              a:hover {
                color: #764ba2;
                transform: translateX(5px);
              }
              a:hover:before {
                transform: translateX(5px);
              }
              .badge {
                background: #667eea;
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.75em;
                margin-left: 8px;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üé® Factors of Colormap</h1>
              
              <div class="section">
                <h2>Colormap Visualizer</h2>
                <ul>
                  <li><a href="Colormap_Visualizer/colormap-visualizer.html">Colormap Visualizer</a></li>
                  <li><a href="Colormap_Visualizer/stimuli-generator.html">Stimuli Generator</a></li>
                </ul>
              </div>
              
              <div class="section">
                <h2>Gaussian Perturbation System</h2>
                <ul>
                  <li><a href="gaussian_perturbation_system/index.html">Gaussian Perturbation System</a></li>
                </ul>
              </div>
              
              <div class="section">
                <h2>Research Materials</h2>
                <ul>
                  <li><a href="rainbows good or bad for/supplementary materials/experiment interface/EXPERIMENT.html">Experiment Interface</a></li>
                </ul>
              </div>
            </div>
          </body>
          </html>
          EOF
          else
            # ÂÖ∂‰ªñÂàÜÊîØÔºöÂ§çÂà∂Âà∞Â≠êÁõÆÂΩï
            cp -r source/Colormap_Visualizer "$TARGET_PATH/"
            cp -r source/gaussian_perturbation_system "$TARGET_PATH/"
            cp -r source/"rainbows good or bad for" "$TARGET_PATH/"
            
            # ‰∏∫Â≠êÁõÆÂΩïÂàõÂª∫Á¥¢ÂºïÈ°µ
            BRANCH_DISPLAY="${{ steps.path.outputs.branch_name }}"
            cat > "$TARGET_PATH/index.html" << EOF
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Factors of Colormap - ${BRANCH_DISPLAY}</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                min-height: 100vh;
                padding: 40px 20px;
              }
              .container { max-width: 900px; margin: 0 auto; }
              h1 {
                color: white;
                text-align: center;
                margin-bottom: 40px;
                font-size: 2.5em;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
              }
              .badge {
                background: rgba(255,255,255,0.3);
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.6em;
                margin-left: 15px;
              }
              .section {
                background: white;
                border-radius: 12px;
                padding: 30px;
                margin-bottom: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
              }
              .section h2 {
                color: #f5576c;
                margin-bottom: 15px;
                font-size: 1.5em;
              }
              ul { list-style: none; }
              li { margin: 12px 0; }
              a {
                color: #f5576c;
                text-decoration: none;
                font-size: 1.1em;
                transition: all 0.3s ease;
              }
              a:before { content: "‚Üí"; margin-right: 8px; }
              a:hover { color: #f093fb; transform: translateX(5px); }
              .back-link {
                display: inline-block;
                background: white;
                color: #f5576c;
                padding: 12px 24px;
                border-radius: 8px;
                text-decoration: none;
                margin-bottom: 20px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
              }
              .back-link:before { content: "‚Üê "; }
            </style>
          </head>
          <body>
            <div class="container">
              <a href="/" class="back-link">Back to Main</a>
              <h1>üé® Factors of Colormap<span class="badge">${BRANCH_DISPLAY}</span></h1>
              
              <div class="section">
                <h2>Colormap Visualizer</h2>
                <ul>
                  <li><a href="Colormap_Visualizer/colormap-visualizer.html">Colormap Visualizer</a></li>
                  <li><a href="Colormap_Visualizer/stimuli-generator.html">Stimuli Generator</a></li>
                </ul>
              </div>
              
              <div class="section">
                <h2>Gaussian Perturbation System</h2>
                <ul>
                  <li><a href="gaussian_perturbation_system/index.html">Gaussian Perturbation System</a></li>
                </ul>
              </div>
              
              <div class="section">
                <h2>Research Materials</h2>
                <ul>
                  <li><a href="rainbows good or bad for/supplementary materials/experiment interface/EXPERIMENT.html">Experiment Interface</a></li>
                </ul>
              </div>
            </div>
          </body>
          </html>
          EOF
          fi
      
      - name: Create .nojekyll file
        run: |
          touch gh-pages/.nojekyll
      
      - name: Deploy to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy ${{ steps.path.outputs.branch_name }} to ${{ steps.path.outputs.deploy_path }}"
            git push origin gh-pages
            echo "‚úÖ Deployed successfully!"
          fi
