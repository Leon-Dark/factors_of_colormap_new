name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - random
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有分支
      
      - name: Determine deployment path
        id: path
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          if [ "$BRANCH_NAME" = "main" ]; then
            DEPLOY_PATH=""
            echo "deploy_path=" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" = "random" ]; then
            DEPLOY_PATH="random"
            echo "deploy_path=random" >> $GITHUB_OUTPUT
          else
            echo "❌ Unknown branch: $BRANCH_NAME"
            exit 1
          fi
          
          echo "Deployment path: $DEPLOY_PATH"
      
      - name: Build site structure
        run: |
          mkdir -p _site/${{ steps.path.outputs.deploy_path }}
          
          # 复制所有文件到对应路径
          if [ -z "${{ steps.path.outputs.deploy_path }}" ]; then
            # main 分支：复制到根目录
            cp -r Colormap_Visualizer _site/
            cp -r gaussian_perturbation_system _site/
            cp -r "rainbows good or bad for" _site/
          else
            # 其他分支：复制到子目录
            cp -r Colormap_Visualizer "_site/${{ steps.path.outputs.deploy_path }}/"
            cp -r gaussian_perturbation_system "_site/${{ steps.path.outputs.deploy_path }}/"
            cp -r "rainbows good or bad for" "_site/${{ steps.path.outputs.deploy_path }}/"
          fi
          
          # 创建索引页面
          if [ -z "${{ steps.path.outputs.deploy_path }}" ]; then
            cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Factors of Colormap</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                line-height: 1.6;
              }
              h1 { color: #333; }
              .section {
                background: #f5f5f5;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
              }
              a {
                color: #0366d6;
                text-decoration: none;
              }
              a:hover {
                text-decoration: underline;
              }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
            </style>
          </head>
          <body>
            <h1>Factors of Colormap</h1>
            
            <div class="section">
              <h2>Colormap Visualizer</h2>
              <ul>
                <li><a href="Colormap_Visualizer/colormap-visualizer.html">Colormap Visualizer</a></li>
                <li><a href="Colormap_Visualizer/stimuli-generator.html">Stimuli Generator</a></li>
              </ul>
            </div>
            
            <div class="section">
              <h2>Gaussian Perturbation System</h2>
              <ul>
                <li><a href="gaussian_perturbation_system/index.html">Gaussian Perturbation System</a></li>
              </ul>
            </div>
            
            <div class="section">
              <h2>Rainbows Good or Bad</h2>
              <ul>
                <li><a href="rainbows good or bad for/supplementary materials/experiment interface/EXPERIMENT.html">Experiment Interface</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
