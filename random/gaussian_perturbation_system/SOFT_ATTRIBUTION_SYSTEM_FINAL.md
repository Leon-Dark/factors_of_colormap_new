# 软归因门控的分频扰动系统 (Soft Attribution Gated Frequency-Specific Perturbation)

---

## 📋 1. 概述 / Overview

本系统实现了基于**梯度能量 (Gradient Energy)** 的软归因门控分频扰动方案。它专门解决多频段高斯场在空间叠加时产生的频段归属模糊问题，实现了对频段的可控、可解释扰动。

核心创新点在于：**不是改变扰动的生成方式，而是改变扰动的应用方式**。

---

## 🎯 2. 核心问题与解决方案

### 2.1 挑战：频段重叠与混叠
在传统的扰动方法中，我们直接修改高斯参数并重新渲染。这会导致：
- **全场影响**：移动一个低频高斯会影响它覆盖的所有区域，即使某些区域本该由高频细节主导。
- **频段混叠**：无法区分"这个像素的变化是由低频引起的还是高频引起的"。

### 2.2 解决方案：软归因门控
我们引入了一个"门控"机制，类似于图像编辑中的**蒙版 (Mask)**。
- **梯度能量归因**：使用梯度能量 `||∇B_k||²` 而非像素值来衡量频段主导性。
- **软归因权重**：允许频段在空间上重叠，计算每个像素点上各频段的相对贡献。
- **平滑门控**：生成平滑的 Mask，只允许扰动在两该频段主导的区域生效。

### 2.3 直观对比
- **传统扰动** = **直接刷油漆**。刷到哪里变哪里，无法保留底下的细节。
- **软归因门控** = **蒙版喷漆**。先贴蒙版，只有蒙版开口（该频段主导）的地方才会上色，且边缘平滑过渡。

---

## 🔄 3. 动态频段分类 (Dynamic Band Classification)

为了确保扰动始终作用于正确的频段，系统实施了**动态频段分类**机制。

### 3.1 为什么需要动态分类？
旧版本使用生成时的固定标签（如 `sizeLevel`），当用户在 UI 中调整 Sigma 滑块时，高斯的实际尺度可能已经改变，但标签没变，导致错误的频段归属。

### 3.2 实现逻辑
根据当前 UI 设置的 Sigma 阈值，实时判断每个高斯属于哪个频段。边界采用相邻频段 Sigma 的**中点**。

**分类规则**：
设 `threshold_1 = (σ_small + σ_medium) / 2`
设 `threshold_2 = (σ_medium + σ_large) / 2`

- **高频 (Small)**: `max(σx, σy) < threshold_1`
- **中频 (Medium)**: `threshold_1 ≤ max(σx, σy) < threshold_2`
- **低频 (Large)**: `max(σx, σy) ≥ threshold_2`

这样确保了用户调整 UI 时，频段划分自动更新。

---

## 🛠️ 4. 系统工作流程 (The 4-Step Process)

系统通过以下四个步骤将扰动应用到图像上：

### 步骤 1: 梯度能量计算 (Gradient Energy)
我们不看像素有多亮，而是看**变化有多剧烈**。
```javascript
E_k(x) = GaussianBlur( ||∇B_k(x)||² , σ_E )
```
- 低频：变化缓慢，梯度小，能量分布广。
- 高频：变化剧烈，梯度大，能量集中。

### 步骤 2: 软归因权重 (Attribution Weights)
计算每个频段在每个像素的相对重要性。
```javascript
α_k(x) = E_k(x) / (E_low + E_mid + E_high + ε)
```
- `α_k` 范围 [0, 1]，且三个频段之和为 1。

### 步骤 3: 生成平滑门控 (Gating Mask)
将权重转化为最终的门控 Mask，消除噪声并平滑边界。
```javascript
m_k(x) = GaussianBlur( smoothstep(α_k; τ_low, τ_high), σ_m )
```
- **Smoothstep**: 软阈值化，去除不重要的微弱信号。
- **GaussianBlur**: 羽化边界，避免产生硬边缘（硬边缘会被误认为是高频信号）。

### 步骤 4: 门控扰动注入 (Gated Injection)
```javascript
Result(x) = Original(x) + Σ [ λ_k · m_k(x) · Δ_k(x) ]
```
- `Δ_k`: 频段 k 的单纯扰动量（扰动后 - 扰动前）。
- `m_k`: 门控 Mask，决定扰动在何处生效。
- `λ_k`: 用户可调的扰动强度。

---

## 🎛️ 5. 参数说明

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **σ_E** (能量平滑) | 4.0 | 用于平滑原始梯度场，避免局部噪点。 |
| **τ** (阈值范围) | 0.3 - 0.7 | Smoothstep 的上下界。低于 0.3 视为 0，高于 0.7 视为 1。 |
| **σ_m** (门控羽化) | 8.0 | 对 Mask 进行模糊，决定边界的柔和程度。 |
| **λ** (频段强度) | 1.0 | 独立控制低、中、高频的扰动注入比例。 |

---

## 💡 6. 常见问题 (Q&A)

### Q: 为什么看起来效果和之前差不多？
**A**: 因为扰动的**生成源头**是一样的（都是通过 `PerturbationSystem` 修改高斯参数）。区别在于**应用方式**：
- 传统方法：一动全动。
- 本方法：只有该频段占主导地位的区域，变化才会显现。
你可以尝试将 `λ_average` (低频强度) 设为 0，你会发现背景的大范围波动完全消失了，即使高斯参数变了。

### Q: 怎么验证它真的在工作？
1. **控制台日志**: 应用扰动时，控制台会输出"抑制率"。例如 `Low band suppression: 35%` 意味着 35% 的低频扰动因为不在其主导区域而被过滤掉了。
2. **可视化视图**: 切换到 **"Gating Mask"** 视图。
    - 亮色区域 = 扰动生效
    - 暗色区域 = 扰动被抑制
    如果你只开启高频扰动，你应该只看到边缘和细节区域在变化。

---

## 📊 7. 可视化工具 (Visualization)

系统提供了专门的视图来调试和验证：
1.  **Attribution Weights**: 查看原始的频段主导性分布 (Viridis 色图)。
2.  **Gating Mask**: 查看经过平滑处理后，实际用于门控的 Mask (Magma 色图)。
3.  **Difference Map**: 传统的差异图，但在本系统中，你会发现差异主要集中在特定频段的活跃区。

---

**文档版本**: Final 1.0
**合并自**: `HOW_SOFT_ATTRIBUTION_WORKS.md`, `SOFT_ATTRIBUTION_PPT.md`, `SOFT_ATTRIBUTION_README.md`, `DYNAMIC_BAND_CLASSIFICATION.md`
