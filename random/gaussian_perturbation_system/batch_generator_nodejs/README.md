# Gaussian Perturbation Batch Generator (Node.js)

è¿™æ˜¯ä¸€ä¸ªNode.jsç‰ˆæœ¬çš„é«˜æ–¯æ‰°åŠ¨åˆºæ¿€æ‰¹é‡ç”Ÿæˆå·¥å…·ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œï¼Œæ— éœ€æµè§ˆå™¨ï¼Œé€‚åˆç”Ÿæˆå¤§é‡æ•°æ®ï¼ˆå¯èƒ½éœ€è¦æ•°å°æ—¶ï¼‰ã€‚

## ç‰¹æ€§

- âœ… **å‘½ä»¤è¡Œè¿è¡Œ**ï¼šæ— éœ€æµè§ˆå™¨ï¼Œé€‚åˆé•¿æ—¶é—´æ‰¹é‡ç”Ÿæˆ
- âœ… **è‡ªå®šä¹‰é…ç½®**ï¼šé€šè¿‡JSONé…ç½®æ–‡ä»¶å®Œå…¨æ§åˆ¶ç”Ÿæˆå‚æ•°
- âœ… **ä¸‰ç§ç”Ÿæˆæ¨¡å¼**ï¼šæ”¯æŒå›ºå®šå¹…åº¦(Magnitude)ã€ç›®æ ‡SSIMã€ç›®æ ‡KLæ•£åº¦
- âœ… **è‡ªåŠ¨ä¼˜åŒ–**ï¼šSSIM/KLæ¨¡å¼ä¸‹è‡ªåŠ¨äºŒåˆ†æœç´¢æœ€ä½³å¹…åº¦
- âœ… **æ‰¹é‡å¯¼å‡º**ï¼šè‡ªåŠ¨ä¿å­˜PNGå›¾åƒå’ŒJSONæ•°æ®
- âœ… **å‹ç¼©æ‰“åŒ…**ï¼šè‡ªåŠ¨åˆ›å»ºZIPå‹ç¼©åŒ…
- âœ… **è¿›åº¦æ˜¾ç¤º**ï¼šå®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿›åº¦

## å®‰è£…

### 1. ç¡®ä¿å·²å®‰è£…Node.js
éœ€è¦Node.js 14+ç‰ˆæœ¬ã€‚æ£€æŸ¥ç‰ˆæœ¬ï¼š
```bash
node --version
```

### 2. å®‰è£…ä¾èµ–
```bash
cd batch_generator_nodejs
npm install
```

è¿™å°†å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š
- `canvas`: ç”¨äºåœ¨Node.jsä¸­ç”Ÿæˆå›¾åƒ
- `archiver`: ç”¨äºåˆ›å»ºZIPå‹ç¼©åŒ…

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

```bash
node batch_generate.js --config config.json
```

### é…ç½®æ–‡ä»¶è¯´æ˜

ç¼–è¾‘ `config.json` æ¥è‡ªå®šä¹‰ç”Ÿæˆå‚æ•°ï¼š

```json
{
  "outputDir": "./output",              // è¾“å‡ºç›®å½•
  "width": 200,                         // ç”»å¸ƒå®½åº¦
  "height": 200,                        // ç”»å¸ƒé«˜åº¦
  "generationMode": "ssim",             // ç”Ÿæˆæ¨¡å¼: "ssim", "kl", "magnitude"
  "repetitions": 2,                     // æ¯ä¸ªé…ç½®é‡å¤ç”Ÿæˆæ¬¡æ•°
  "frequencies": ["low", "medium", "high"], // è¦ç”Ÿæˆçš„é¢‘æ®µ
  
  // SSIMæ¨¡å¼é…ç½®
  "ssim": {
    "start": 0.99,                     // èµ·å§‹SSIMå€¼
    "end": 0.95,                        // ç»“æŸSSIMå€¼
    "step": 0.002                       // æ­¥é•¿
  },
  
  // KLæ•£åº¦æ¨¡å¼é…ç½®
  "kl": {
    "start": 0.01,
    "end": 0.10,
    "step": 0.02
  },
  
  // å›ºå®šå¹…åº¦æ¨¡å¼é…ç½®
  "magnitudes": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
  
  // é¢‘æ®µæ··åˆå‚æ•°
  "mixingParameters": {
    "weightHigh": 1.0,                  // é«˜é¢‘æƒé‡
    "weightMid": 1.5,                   // ä¸­é¢‘æƒé‡
    "weightLow": 3.0,                   // ä½é¢‘æƒé‡
    "exponent": 1.0                     // æŒ‡æ•°
  },
  
  // æ‰°åŠ¨ç³»æ•°
  "perturbationCoefficients": {
    "position": 0,                      // ä½ç½®æ‰°åŠ¨ç³»æ•°
    "stretch": 0.0,                     // æ‹‰ä¼¸æ‰°åŠ¨ç³»æ•°
    "rotation": 1.0,                    // æ—‹è½¬æ‰°åŠ¨ç³»æ•°
    "amplitude": 1.0                    // å¹…åº¦æ‰°åŠ¨ç³»æ•°
  },
  
  // é«˜æ–¯å°ºå¯¸é…ç½®
  "sizeLevels": {
    "small": { "sigma": 15, "count": 2 },
    "medium": { "sigma": 25, "count": 3 },
    "large": { "sigma": 50, "count": 4 }
  },
  
  // è½¯å½’å› é—¨æ§å‚æ•°
  "softAttributionParams": {
    "sigma_E_ratio": 0.4,
    "sigma_m_ratio": 0.6,
    "sigma_Delta_ratio": 0.4,
    "tau_low": 0.3,
    "tau_high": 0.7
  },
  
  // å¯¼å‡ºé€‰é¡¹
  "exportOptions": {
    "saveImages": true,                 // æ˜¯å¦ä¿å­˜å›¾åƒ
    "saveJSON": true,                   // æ˜¯å¦ä¿å­˜JSON
    "imageFormat": "png"                // å›¾åƒæ ¼å¼
  }
}
```

## ç”Ÿæˆæ¨¡å¼

### 1. SSIMæ¨¡å¼ (æ¨è)
æ ¹æ®ç›®æ ‡ç»“æ„ç›¸ä¼¼æ€§æŒ‡æ•°ç”Ÿæˆï¼š
```json
{
  "generationMode": "ssim",
  "ssim": {
    "start": 0.995,
    "end": 0.95,
    "step": 0.005
  }
}
```
ç”Ÿæˆåºåˆ—ï¼š0.995, 0.990, 0.985, ..., 0.950

### 2. KLæ•£åº¦æ¨¡å¼
æ ¹æ®ç›®æ ‡KLæ•£åº¦ç”Ÿæˆï¼š
```json
{
  "generationMode": "kl",
  "kl": {
    "start": 0.01,
    "end": 0.10,
    "step": 0.02
  }
}
```
ç”Ÿæˆåºåˆ—ï¼š0.01, 0.03, 0.05, ..., 0.10

### 3. å›ºå®šå¹…åº¦æ¨¡å¼
ä½¿ç”¨é¢„å®šä¹‰çš„æ‰°åŠ¨å¹…åº¦ï¼š
```json
{
  "generationMode": "magnitude",
  "magnitudes": [1, 2, 3, 4, 5]
}
```

## è¾“å‡ºç»“æ„

```
output/
â”œâ”€â”€ perturbation_data_2026-01-21.json    # JSONæ•°æ®æ–‡ä»¶
â”œâ”€â”€ perturbation_images_2026-01-21.zip   # å›¾åƒå‹ç¼©åŒ…
â””â”€â”€ images/                               # å›¾åƒç›®å½•
    â”œâ”€â”€ 0001_low_ssim_0.99500_rep1_original.png
    â”œâ”€â”€ 0001_low_ssim_0.99500_rep1_perturbed.png
    â”œâ”€â”€ 0001_low_ssim_0.99500_rep1_metadata.json
    â”œâ”€â”€ 0002_low_ssim_0.99500_rep2_original.png
    â”œâ”€â”€ ...
```

### JSONæ•°æ®æ ¼å¼

```json
[
  {
    "frequency": "low",
    "frequencyName": "Low Complexity",
    "targetValue": 0.995,
    "repetition": 1,
    "mode": "ssim",
    "magnitude": 0.234,
    "ssim": 0.99501,
    "kl": 0.00123,
    "dataOriginal": [...],
    "dataPerturbed": [...],
    "config": {
      "width": 200,
      "height": 200
    }
  }
]
```

## ç”Ÿæˆæ—¶é—´ä¼°ç®—

ç”Ÿæˆæ—¶é—´å–å†³äºï¼š
- ç”Ÿæˆæ¨¡å¼ï¼ˆSSIM/KLéœ€è¦ä¼˜åŒ–ï¼Œè¾ƒæ…¢ï¼‰
- ç›®æ ‡æ•°é‡
- é‡å¤æ¬¡æ•°
- é¢‘æ®µæ•°é‡

**ä¼°ç®—å…¬å¼**ï¼š
```
æ€»æ•° = é¢‘æ®µæ•° Ã— ç›®æ ‡æ•° Ã— é‡å¤æ¬¡æ•°
æ—¶é—´ â‰ˆ æ€»æ•° Ã— (2-5ç§’æ¯ä¸ªåˆºæ¿€ï¼ŒSSIM/KLæ¨¡å¼)
æ—¶é—´ â‰ˆ æ€»æ•° Ã— (0.5ç§’æ¯ä¸ªåˆºæ¿€ï¼ŒMagnitudeæ¨¡å¼)
```

**ç¤ºä¾‹**ï¼š
- 3é¢‘æ®µ Ã— 10ç›®æ ‡ Ã— 2é‡å¤ = 60ä¸ªåˆºæ¿€
- SSIMæ¨¡å¼ï¼šçº¦2-5åˆ†é’Ÿ
- Magnitudeæ¨¡å¼ï¼šçº¦30ç§’

**å¤§è§„æ¨¡ç”Ÿæˆç¤ºä¾‹**ï¼š
- 3é¢‘æ®µ Ã— 50ç›®æ ‡ Ã— 5é‡å¤ = 750ä¸ªåˆºæ¿€
- SSIMæ¨¡å¼ï¼šçº¦25-63åˆ†é’Ÿ

## é«˜çº§ç”¨æ³•

### åªç”Ÿæˆç‰¹å®šé¢‘æ®µ
```json
{
  "frequencies": ["low"]  // åªç”Ÿæˆä½é¢‘
}
```

### è°ƒæ•´ä¼˜åŒ–å‚æ•°
ä¿®æ”¹ `batch_generate.js` ä¸­çš„ä¼˜åŒ–å‚æ•°ï¼š
```javascript
const tolerance = 0.0001;     // ä¼˜åŒ–ç²¾åº¦
const maxRetries = 6;         // æœ€å¤§é‡è¯•æ¬¡æ•°
const maxIterPerTry = 60;     // æ¯æ¬¡å°è¯•çš„æœ€å¤§è¿­ä»£æ¬¡æ•°
```

### è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„
```json
{
  "outputDir": "D:/my_stimuli_output"
}
```

## å¸¸è§é—®é¢˜

### Q: å®‰è£…canvasæ¨¡å—å¤±è´¥ï¼Ÿ
A: Windowsç”¨æˆ·å¯èƒ½éœ€è¦å®‰è£…æ„å»ºå·¥å…·ï¼š
```bash
npm install --global windows-build-tools
```
æˆ–è€…è®¿é—® https://github.com/Automattic/node-canvas æŸ¥çœ‹è¯¦ç»†å®‰è£…æŒ‡å—ã€‚

### Q: ç”Ÿæˆæ—¶é—´å¤ªé•¿ï¼Ÿ
A: å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
1. å‡å°‘ç›®æ ‡æ•°é‡æˆ–é‡å¤æ¬¡æ•°
2. ä½¿ç”¨magnitudeæ¨¡å¼ä»£æ›¿SSIM/KLæ¨¡å¼
3. åªç”Ÿæˆå•ä¸ªé¢‘æ®µæµ‹è¯•

### Q: å†…å­˜ä¸è¶³ï¼Ÿ
A: å¦‚æœç”Ÿæˆå¤§é‡æ•°æ®ï¼š
1. å‡å°å›¾åƒå°ºå¯¸ï¼ˆwidth/heightï¼‰
2. åˆ†æ‰¹ç”Ÿæˆï¼ˆä¿®æ”¹frequencieså‚æ•°ï¼‰
3. å¢åŠ Node.jså†…å­˜é™åˆ¶ï¼š
```bash
node --max-old-space-size=4096 batch_generate.js --config config.json
```

### Q: å¦‚ä½•éªŒè¯ç»“æœï¼Ÿ
A: æ£€æŸ¥ï¼š
1. JSONæ–‡ä»¶ä¸­çš„ssimå’Œklå€¼æ˜¯å¦æ¥è¿‘targetValue
2. å›¾åƒæ–‡ä»¶æ˜¯å¦æ­£ç¡®ç”Ÿæˆ
3. metadata.jsonä¸­çš„å‚æ•°æ˜¯å¦æ­£ç¡®

## ä¸æµè§ˆå™¨ç‰ˆæœ¬çš„åŒºåˆ«

| ç‰¹æ€§ | æµè§ˆå™¨ç‰ˆæœ¬ | Node.jsç‰ˆæœ¬ |
|------|-----------|------------|
| è¿è¡Œç¯å¢ƒ | éœ€è¦æµè§ˆå™¨ | å‘½ä»¤è¡Œ |
| é€‚ç”¨åœºæ™¯ | å°è§„æ¨¡é¢„è§ˆ | å¤§è§„æ¨¡æ‰¹é‡ç”Ÿæˆ |
| ç”¨æˆ·ç•Œé¢ | å›¾å½¢ç•Œé¢ | é…ç½®æ–‡ä»¶ |
| ç”Ÿæˆé€Ÿåº¦ | è¾ƒæ…¢ï¼ˆUIé˜»å¡ï¼‰ | æ›´å¿« |
| é•¿æ—¶é—´è¿è¡Œ | ä¸ç¨³å®š | ç¨³å®š |
| å®æ—¶é¢„è§ˆ | âœ… | âŒ |
| æ‰¹é‡å¯¼å‡º | âœ… | âœ… |

## æŠ€æœ¯ç»†èŠ‚

### æ ¸å¿ƒç®—æ³•
- **BiGauss**: äºŒç»´é«˜æ–¯åˆ†å¸ƒå®ç°
- **Force-Directed Relaxation**: é«˜æ–¯å¸ƒå±€ä¼˜åŒ–
- **Binary Search**: SSIM/KLç›®æ ‡å€¼ä¼˜åŒ–
- **Soft Attribution Gating**: é¢‘ç‡é€‰æ‹©æ€§æ‰°åŠ¨

### æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨Float32Arrayå‡å°‘å†…å­˜å ç”¨
- åˆ†ç¦»å·ç§¯å®ç°é«˜æ–¯æ¨¡ç³Š
- è‡ªé€‚åº”å‚æ•°å‡å°‘è®¡ç®—é‡
- è¾¹ç•Œç›’è£å‰ªå‡å°‘ä¸å¿…è¦çš„è®¡ç®—

## å¼€å‘è¯´æ˜

å¦‚æœéœ€è¦ä¿®æ”¹ä»£ç ï¼Œä¸»è¦ç±»å’Œå‡½æ•°ï¼š

- `BiGauss`: é«˜æ–¯åˆ†å¸ƒç±»
- `GaussianGenerator`: é«˜æ–¯åœºç”Ÿæˆå™¨
- `PerturbationSystem`: æ‰°åŠ¨ç³»ç»Ÿ
- `SoftAttributionPerturbation`: è½¯å½’å› é—¨æ§ç³»ç»Ÿ
- `BatchGenerator`: æ‰¹é‡ç”Ÿæˆä¸»æ§åˆ¶å™¨

## è®¸å¯è¯

MIT License

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

---

**Happy Generating! ğŸ¨**
